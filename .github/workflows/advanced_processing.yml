name: Advanced ZIP Processing & Content Generation

on:
  workflow_dispatch:
  push:
    paths:
      - 'config.yml'
      - 'config-1.yml'

jobs:
  process-files:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 30

    steps:
      - name: ⚡ Set timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Validate configs
        run: |
          [ -f config-1.yml ] || { echo "❌ Missing config-1.yml"; exit 1; }
          [ -f config.yml ] || { echo "❌ Missing config.yml"; exit 1; }
          grep -qE '^\s*-' config-1.yml || { echo "❌ No ZIPs in config-1.yml"; exit 1; }
          grep -qE '^\s*folders:' config.yml || { echo "❌ No folders in config.yml"; exit 1; }

      - name: 📦 Smart ZIP extraction
        run: |
          mkdir -p extracted_assets
          grep -E '^\s*-' config-1.yml | sed 's/^[[:space:]]*-\s*//;s/"//g' | while read -r zip; do
            if [ ! -f "$zip" ]; then
              echo "::error::ZIP missing: $zip"
              exit 1
            fi
            echo "🔓 Extracting: $zip"
            unzip -q -n "$zip" -d extracted_assets/
          done
          echo "🗂️ Extracted assets: $(find extracted_assets -type f | wc -l) files"

      - name: 🧠 Intelligent content processing
        id: processor
        uses: actions/github-script@v6
        env:
          TIMESTAMP: ${{ steps.timestamp.outputs.TIMESTAMP }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const yaml = require('js-yaml');
            const { glob } = require('glob');

            // 1. Combine all files into data.txt
            let combinedContent = '';
            const files = await glob('extracted_assets/**/*', { nodir: true });
            
            files.forEach(file => {
              try {
                const content = fs.readFileSync(file, 'utf-8');
                const relativePath = path.relative('extracted_assets', file);
                combinedContent += `===== ${relativePath} =====\n${content}\n\n`;
              } catch (e) {
                core.warning(`Skipped ${file}: ${e.message}`);
              }
            });

            fs.writeFileSync('data.txt', combinedContent);
            console.log(`📝 Combined ${files.length} files into data.txt`);

            // 2. Generate individual summaries
            const config = yaml.load(fs.readFileSync('config.yml', 'utf8'));
            const patterns = config.folders || [];
            const summaryDir = 'generated';
            fs.mkdirSync(summaryDir, { recursive: true });

            let generatedCount = 0;
            for (const pattern of patterns) {
              const matches = await glob(`extracted_assets/${pattern}`, { nodir: true });
              
              for (const file of matches) {
                try {
                  const content = fs.readFileSync(file, 'utf-8');
                  const relativePath = path.relative('extracted_assets', file);
                  const safeName = relativePath.replace(/\//g, '꞉').replace(/\\/g, '꞉').replace(/\s+/g, '🝗');
                  const summaryFile = `${summaryDir}/${safeName}_${{ env.TIMESTAMP }}.txt`;
                  
                  fs.writeFileSync(summaryFile, `🔖 ${relativePath}\n\n${content}`);
                  generatedCount++;
                } catch (e) {
                  core.warning(`Skipped ${file}: ${e.message}`);
                }
              }
            }
            console.log(`✨ Generated ${generatedCount} summaries`);
            core.setOutput('changes', generatedCount > 0 ? 'true' : 'false');

      - name: 🧹 Cleanup assets
        if: always()
        run: rm -rf extracted_assets

      - name: 💾 Smart commit
        if: steps.processor.outputs.changes == 'true'
        run: |
          git config user.name "Cognitive Processor"
          git config user.email "ai-assistant@users.noreply.github.com"
          git add data.txt generated/
          git commit -m "🧠 AI-Processed Content v${{ steps.timestamp.outputs.TIMESTAMP }}"
          git push

      - name: 🚀 Create PR
        if: steps.processor.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          title: "AI-Generated Content Update v${{ steps.timestamp.outputs.TIMESTAMP }}"
          body: "Automated content processing:\n- Combined files: data.txt\n- Individual summaries: generated/"
          branch: "content-update-${{ steps.timestamp.outputs.TIMESTAMP }}"
          delete-branch: true
