name: Generate Summaries from Config

on:
  push:
    branches: [main]

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.x

    - name: Install PyYAML
      run: pip install pyyaml

    - name: Generate summaries from folders in config.yml
      run: |
        mkdir -p generated

        python3 <<EOF
        import yaml
        from pathlib import Path
        import glob
        from datetime import datetime

        # Timestamp format
        timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")

        # Load config file
        config_path = Path("config.yml")
        if not config_path.exists():
            print("❌ config.yml not found")
            exit(1)

        with open(config_path) as f:
            config = yaml.safe_load(f)

        patterns = config.get("folders", [])
        if not patterns:
            print("❌ No folders listed in config.yml")
            exit(1)

        seen = set()
        for pattern in patterns:
            for path in glob.glob(pattern, recursive=True):
                p = Path(path)
                if p.is_file() and p not in seen:
                    seen.add(p)
                    safe_name = p.name.replace(" ", "_")
                    output_file = Path("generated") / f"{safe_name}-data-{timestamp}.txt"
                    try:
                        content = p.read_text(encoding="utf-8")
                    except Exception as e:
                        print(f"❌ Failed reading {p}: {e}")
                        continue
                    with open(output_file, "w", encoding="utf-8") as out:
                        out.write(f"({p})\n-\n{content}")
                        print(f"✅ Wrote {output_file}")
        EOF

    - name: Commit summaries
      run: |
        git config user.name "Folder Bot"
        git config user.email "bot@example.com"
        git add generated/
        git commit -m "📄 Generated summaries with timestamp" || echo "Nothing to commit"
        git push
